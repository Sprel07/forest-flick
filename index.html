<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Forest Flick</title>
<style>
body{margin:0;background:#070b18;color:white;font-family:sans-serif}
button{padding:8px;margin:4px}
canvas{display:block;margin:auto;background:#0d1533;border-radius:12px}
#menu,#lobby,#hud{text-align:center}
.hidden{display:none}
</style>
</head>
<body>

<div id="menu">
  <input id="name" placeholder="Your name">
  <input id="code" placeholder="Room">
  <button onclick="join()">Join</button>
  <button onclick="create()">Create</button>
</div>

<div id="lobby" class="hidden">
  <div id="players"></div>
  <button onclick="ready()">Ready</button>
  <button onclick="start()">Start</button>
</div>

<canvas id="c" width="960" height="540"></canvas>

<script>
const ws=new WebSocket(`ws://${location.host}`);
const ctx=c.getContext("2d");
let game=null;

ws.onmessage=e=>{
  const m=JSON.parse(e.data);

  if(m.t==="created"){ code.value=m.code }

  if(m.t==="lobby"){
    menu.classList.add("hidden");
    lobby.classList.remove("hidden");
    players.innerHTML=Object.values(m.room.lobby.players)
      .map(p=>`${p.name} ${p.ready?"âœ”":""}`).join("<br>");
  }

  if(m.t==="game"){
    lobby.classList.add("hidden");
    game=m.game;
    draw();
  }
};

function create(){ ws.send(JSON.stringify({t:"create"})) }
function join(){
  ws.send(JSON.stringify({t:"join",code:code.value,name:name.value}))
}
function ready(){ ws.send(JSON.stringify({t:"ready",v:true})) }
function start(){ ws.send(JSON.stringify({t:"start"})) }

let drag=false,sx,sy;
c.onmousedown=e=>{drag=true;sx=e.offsetX;sy=e.offsetY};
c.onmouseup=e=>{
  if(!drag)return;drag=false;
  ws.send(JSON.stringify({
    t:"flick",
    vx:(sx-e.offsetX)*3,
    vy:(sy-e.offsetY)*3
  }));
};

function draw(){
  ctx.clearRect(0,0,960,540);
  if(!game) return;

  ctx.fillStyle="#345";
  game.map.walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));

  if(game.map.finish){
    ctx.fillStyle="#2f6";
    ctx.fillRect(game.map.finish.x,game.map.finish.y,game.map.finish.w,game.map.finish.h);
  }

  if(game.boss){
    ctx.beginPath();
    ctx.arc(game.boss.x,game.boss.y,game.boss.r,0,Math.PI*2);
    ctx.fillStyle="#f44";
    ctx.fill();
  }

  Object.values(game.players).forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle=p.color;
    ctx.fill();
    ctx.fillText(`${p.name} (${p.hp})`,p.x-15,p.y-22);
  });
}
</script>
</body>
</html>
